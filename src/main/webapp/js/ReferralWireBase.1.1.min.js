(function(h,a){if("object"===typeof exports){var m=require("jquery"),p=require("underscore"),r=require("backbone"),l=require("rwcore"),c=require("templatecache");module.exports=a(m,p,r,l,c)}else"function"===typeof define&&define.amd&&define(["jquery","underscore","backbone","rwcore","templatecache"],a)})(this,function(h,a,m,p,r){r=r||window.jQuery||window.Zepto||window.ender;var l={};l.extend=m.Model.extend;l.Templatecache=r;l.init=function(a){l.options=a;var g=localStorage.getItem("rwAppVersion");
if(!h.hasVal(g)||g!=a.AppVer)localStorage.clear(),localStorage.setItem("rwAppVersion",a.AppVer)};l.FullContact={findByEmail:function(a){a=p.getJSON("/rwWebRequest?module=ContactsMgr&act=FullContact&emailAddress="+a);return jQuery.parseJSON(a.data)}};l.setDefaultValues=function(c,g,e){if(!h.hasVal(g.model.attributes.field))return"";var d=h.toArray(g.model.attributes.field),f={};a.each(d,function(b){f[b.fldname]="";h.hasVal(e)&&(f[d.fldname]=e.get(b.fldname));if(!h.hasVal(f[b.fldname])&&h.hasVal(b.defaultValue)){var c=
b.defaultValue;-1<c.indexOf("[")&&(c=c.replace("[",""),c=c.replace("]",""),c=rwFB[c]);f[b.fldname]=c;"address"==b.dataType&&(b=h.toArray(b.part),a.each(b,function(a){h.hasVal(f[a.fldname])||(c=a.defaultValue,-1<c.indexOf("[")&&(c=c.replace("[",""),c=c.replace("]",""),c=rwFB[c]),f[a.fldname]=c)}))}});c.set(f);return!0};l.fieldRenderer=function(a,g){return(new l.FieldView({field:a})).render(g).el.innerHTML};l.validateRequired=function(c,g){var e=g.model.attributes.field;if(a.isUndefined(e))return null;
!1==a.isArray(e)&&(e=[e]);for(var d={},f=0;f<e.length;f++){var b=e[f].required;if(!a.isUndefined(b)&&!0==b){var b=e[f].fldname,k=c.get(b),l=e[f].label;if(a.isUndefined(k)||a.isNull(k)||""==k){k=l.match(RegExp(/\[(.*?)\]/g));if(h.hasVal(k)&&0<k.length)for(j=0;j<k.length;j++)var p=k[j],q=p.replace("[",""),q=q.replace("]",""),q=c.get(q),l=l.replace(p,q);d[b]='"'+l+'"<p>'}}}return a.isEmpty(d)?null:d};l.recordBinder=function(c,g){if(!h.hasVal(g))return c;for(var e=c.querySelectorAll("input"),d=0;d<e.length;d++)if(!a.isEmpty(e[d].id)){var f=
h(e[d]).attr("databind");if(a.isEmpty(f)&&"false"!=f&&(f=g.attributes[e[d].id],e[d].setAttribute("value",""),!a.isUndefined(f)&&!a.isNull(f))){var b=e[d].type,k=!a.isUndefined(e[d].name)?e[d].name:"";e[d].setAttribute("value",f);"checkbox"==b?(b=!a.isUndefined(e[d].attributes.multicheckbox)||!a.isUndefined(e[d].attributes.multicheckbox_search)?!0:!1,"true"==f&!b&&e[d].setAttribute("checked","checked"),f=new String(f),b&&-1<f.indexOf(k)&&e[d].setAttribute("checked","checked")):"radio"==b&&k==f&&e[d].setAttribute("checked",
"true")}}k=c.querySelectorAll("select");for(d=0;d<k.length;d++)if(!a.isEmpty(k[d].id)){f=g.attributes[k[d].id];b=k[d].options;for(e=0;e<b.length;e++)b[e].removeAttribute("selected");if(!a.isUndefined(f)&&!a.isNull(f)&&!a.isEmpty(f))for(e=0;e<b.length;e++)b[e].value===f&&b[e].setAttribute("selected","true");else b[0].setAttribute("selected","true")}e=c.querySelectorAll("img");for(d=0;d<e.length;d++)a.isEmpty(e[d].id)||(f=g.attributes[e[d].id],!a.isUndefined(f)&&(!a.isNull(f)&&""!=f)&&e[d].setAttribute("src",
f));e=c.querySelectorAll("textarea");for(d=0;d<e.length;d++)a.isEmpty(e[d].id)||(f=g.attributes[e[d].id],!a.isUndefined(f)&&!a.isNull(f)&&(e[d].innerHTML=f));var k=c.querySelectorAll("[bulletlist]"),b=h(a.template("Snippets")()).find(".profileBulletList"),l=h(a.template("Snippets")()).find(".profileBulletItem");h(a.template("Snippets")()).find(".bulletGroupContainer");for(d=0;d<k.length;d++)if(!a.isEmpty(k[d].id)){var m=b.clone();h(k[d]).show();h(k[d]).find("ul").remove();f=g.attributes[k[d].id];
if(!a.isUndefined(f)&&!a.isNull(f)&&""!=f){f=f.split("\n");for(e=0;e<f.length;e++){var q=l.clone();q.html(f[e]);m.append(q)}h(k[d]).append(m)}else h(k[d]).hide()}e=c.querySelectorAll("span");for(d=0;d<e.length;d++)a.isEmpty(e[d].id)||(f=g.attributes[e[d].id],!a.isUndefined(f)&&!a.isNull(f)&&(e[d].innerHTML=f));e=c.querySelectorAll("[pickapplet] span");for(d=0;d<e.length;d++)a.isEmpty(e[d].id)||(f=g.attributes[e[d].id],!1==h.hasVal(f)&&(e[d].innerHTML="Choose One"));d=/Zlhs/g;f=c.innerHTML;f=f.replace(d,
"<%=");d=/Zrhs/g;f=f.replace(d,"%>");return a.template(f,{model:g,_:a,getLovDisplayVal:p.getLovDisplayVal})};l.PickList=m.View.extend({initialize:function(a){this.options=a;this.pickListTemplate=h.hasVal(a.pickTemplate)?a.pickTemplate:requirejs("text!/Templates/Lists/StdPicklistTemplate.html")},render:function(c){h(this.el).html(a.template(this.pickListTemplate,{model:this.model,key:this.options.key,display:this.options.display,displayListField:this.options.displayListField,radioField:this.options.radioField,
fldname:this.options.fldname,order:this.options.order,readonly:c,_:a}));return this}});l.FieldModel=m.Model.extend();l.FieldView=m.View.extend({initialize:function(a){this.model=a.field},render:function(c){var g=this,e=g.model.dataType,d=l.Templatecache.fields[e],f="Captcha"==e&&!1==c?p.GetCaptcha():"",b=a.template(d,{readonly:c,attributes:this.model,url:f,_:a}),k=g.model.lovType,m=g.model.lovGroup,d=g.model.pickApplet,f=g.model.pickListTemplate,z=g.model.lookupKeyField,q=g.model.lookupDisplayField;
if(h.hasVal(k)&&a.isUndefined(d)){var r=this.model.dynamicFilterValue,s=this.model.applyFilterToLovField,u=!1,t=null;h.hasVal(r)&&h.hasVal(s)&&(t={},t[s]=r,u=!0);(new p.LOVCollection({module:"LovMgr",LovType:k,Locale:"ENU",Group:a.isNull(m)?void 0:m,constraint:a.isNull(t)?void 0:t,skipCache:u})).fetch({add:!0,async:!1,error:p.ShowError,success:function(a){var d="StdPickList";"radio"==e&&(d="RadioButtons");"multicheckbox"==e&&(d="MultiCheckBoxes");"multicheckbox_search"==e&&(d="MultiCheckBoxes_Search");
b=(new l.PickList({model:a,fldname:g.model.fldname,displayListField:g.model.displayListField,pickTemplate:d,key:z,display:q})).render(c).el.innerHTML}})}a.contains(["radio","multicheckbox_search"],e)&&h.hasVal(d)&&(k=null,"radio"==e&&(k="RadioButtonsDynamic"),"multicheckbox"==e&&(k="MultiCheckBoxes"),"multicheckbox_search"==e&&(k=f),f=this.model.radioList,m=h.hasVal(g.model.radioField)?g.model.radioField:g.model.fldname,b=(new l.PickList({model:f,fldname:g.model.fldname,displayListField:g.model.displayListField,
order:g.model.order,radioField:m,pickTemplate:k,key:z,display:q})).render(c).el.innerHTML);!1==c?h.hasVal(d)&&!a.contains(["radio","multicheckbox_search"],e)&&(b=a.template("pickLaunchButton",{insideHtml:b,model:g.model})):(d=g.model.drilldown,!a.isUndefined(d)&&(!a.isNull(d)&&0<d.length)&&(b=a.template("drilldownTemplate",{insideHtml:b,model:g.model})));h(this.el).html(b);return this}});l.RepoObjectModel=m.Model.extend({options:null,sync:function(){var c=localStorage.getItem(this.options.type+"."+
this.options.name);!a.isUndefined(c)&&!a.isNull(c)?this.set(JSON.parse(c)):(c=p.getJSON("/rwWebRequest?module=RepoMgr&act="+this.options.type+"&name="+this.options.name),!a.isUndefined(c)&&!a.isNull(c)&&(this.set(c),localStorage.setItem(this.options.type+"."+this.options.name,JSON.stringify(this))))},initialize:function(c){this.options=c;a.isUndefined(c)?p.FYI("Repo Data is missing"):this.sync()}});l.AppletView=m.View.extend({actor:"",applet:"",template:"",showViewBar:!1,viewBarTemplate:null,initialize:function(c){this.applet=
c.applet;this.template=c.template;this.model=new l.RepoObjectModel({type:"Applet",name:this.applet});this.actor=this.model.get("actor");this.bc=this.model.get("bc");this.bo=this.model.get("bo");this.clickRoute=c.clickRoute;this.viewBarTemplate="ActionBarTemplate";!a.isUndefined(c.viewBarTemplate)&&!a.isNull(c.viewBarTemplate)&&(this.viewBarTemplate=c.viewBarTemplate);!a.isUndefined(c.showViewBar)&&(!a.isNull(c.showViewBar)&&c.showViewBar)&&(this.showViewBar=!0);this.options=c},renderFields:function(c){var g=
this.model.attributes.field;if(a.isUndefined(g))return"";c=h.hasVal(c)&&h.hasVal(c.data)?c.data:null;g=h.toArray(g);g=a.sortBy(g,function(a){return parseInt(a.order)});return a.template(this.options.template,{attributes:g,_:a,applet:this.model.attributes,data:c,fieldRenderer:l.fieldRenderer,metaApplet:this.model.attributes})},renderActionsBar:function(){var c=this.model.attributes.action;if(a.isUndefined(c))return"";c=h.toArray(c);c=a.sortBy(c,function(a){return parseInt(a.order)});return a.template(this.viewBarTemplate,
{attributes:c,_:a,applet:this.model.attributes,clickRoute:this.clickRoute})},render:function(c){var g=a.isUndefined(this.clickRoute)?"":this.clickRoute,g=this.applet+this.template+g,e=p.cacheout(g);if(a.isUndefined(e)||a.isNull(e))e=this.showViewBar?this.renderFields(c)+this.renderActionsBar():this.renderFields(c),p.cachein(g,e);h(this.el).html(e);return this}});l.vCard_fileimport=function(c){var g=h.Deferred(),e=void 0,e=h.browser.msie?(new ActiveXObject("Scripting.FileSystemObject")).OpenTextFile(c.target.value).ReadAll():
c.target.files[0];void 0!=e&&(c=new FileReader,c.onload=function(c){var e=new p.StandardCollection({module:"ContactsMgr"});e.comparator=function(a){return a.get("firstName")};e.reset();c=c.target.result.split(/END:VCARD/);for(n in c){vCard=c[n];var b={};h.vcard_parse(vCard,b);if(!a.isEmpty(b.fn)){var k=b.fn.trim().split(" "),l="",m="",q="",r="",s="",u="",t="";a.isUndefined(k[0])||(l=k[0]);a.isUndefined(k[2])?a.isUndefined(k[1])||(m=k[1]):m=k[2];a.isUndefined(b.title)||(q=b.title);a.isUndefined(b.org)||
(r=b.org);if("2.1"==b.version)!a.isUndefined(b.email)&&!a.isUndefined(b.email.internet[0])&&(s=b.email.internet[0]);else if("3.0"==b.version){!a.isUndefined(b.email)&&a.isUndefined(b.email["type=work"])&&a.isUndefined(b.email.work)?s=b.email[0]:(!a.isUndefined(b.email)&&!a.isUndefined(b.email["type=work"])&&(s=b.email["type=work"][0]),!a.isUndefined(b.email)&&!a.isUndefined(b.email.work)&&(s=b.email.work[0]));!a.isUndefined(b.tel)&&a.isUndefined(b.tel["type=work"])&&a.isUndefined(b.tel.work)?u=b.tel[0]:
(!a.isUndefined(b.tel)&&!a.isUndefined(b.tel["type=work"])&&(u=b.tel["type=work"][0]),!a.isUndefined(b.tel)&&!a.isUndefined(b.tel.work)&&(u=b.tel.work[0]));!a.isUndefined(b.tel)&&!a.isUndefined(b.tel["type=cell"])&&(t=b.tel["type=cell"][0]);!a.isUndefined(b.tel)&&!a.isUndefined(b.tel.voice)&&(t=b.tel.voice[1]);var v,w,x,y,A;!a.isUndefined(b.adr)&&a.isUndefined(b.adr["type=work"])&&a.isUndefined(b.adr.work)?(v=b.adr["default"][0][2],w=b.adr["default"][0][3],x=b.adr["default"][0][4],y=b.adr["default"][0][5]):
(!a.isUndefined(b.adr)&&!a.isUndefined(b.adr["type=work"])&&(v=b.adr["type=work"][0][2],w=b.adr["type=work"][0][3],x=b.adr["type=work"][0][4],y=b.adr["type=work"][0][5]),!a.isUndefined(b.adr)&&!a.isUndefined(b.adr.work)&&(v=b.adr.work[0][2],w=b.adr.work[0][3],x=b.adr.work[0][4],y=b.adr.work[0][5]));!a.isUndefined(b.url)&&!a.isUndefined(b.url.home)&&(A=b.url.home[0])}b=new p.StandardModel({module:"ContactsMgr"});b.set({firstName:l,lastName:m,jobTitle:q,business:r,workPhone:u,mobilePhone:t,emailAddress:s,
streetAddress1_work:v,cityAddress_work:w,stateAddress_work:x,postalCodeAddress_work:y,photoUrl:void 0,note:A});e.add(b,{silent:!0})}}g.resolve(e)},c.readAsText(e));return g};l.ExportContactsToServer=function(a){var g=h.Deferred();a=h.ajax({type:"POST",url:"/rwWebRequest?",async:!0,cache:!0,dataType:"json",data:{data:JSON.stringify({module:"ContactsMgr",act:"importContacts",contacts:a})}});a.done(function(a){g.resolve(a)});a.fail(function(a,c,f){p.showError(a,c,f);g.resolve()});return g};l.GetOutlookContactsCollection=
function(){if(h.browser.msie)try{var a=(new ActiveXObject("Outlook.Application")).GetNamespace("MAPI");if(a){var g=a.GetDefaultFolder(10),e=new p.StandardCollection({module:"ContactsMgr"});e.comparator=function(a){return a.get("firstName")};for(a=1;a<=g.items.count;a++){var d=g.items(a),f=new p.StandardModel({module:"ContactsMgr"});h.hasVal(d.FirstName)&&h.hasVal(d.LastName)&&(f.set({firstName:d.FirstName,lastName:d.LastName,workPhone:d.BusinessTelephoneNumber,mobilePhone:d.MobileTelephoneNumber,
emailAddress:d.Email1Address,streetAddress1:d.BusinessAddress,cityAddress:d.BusinessAddressCity,stateAddress:d.BusinessAddressState,business:d.CompanyName,postalCodeAddress:d.BusinessAddressPostalCode}),e.add(f,{silent:!0}))}return e}}catch(b){return p.FYI("Outlook needs to be installed on this computer for importing contacts."),null}};l.enrichParty=function(){var a=new p.StandardModel({module:"ContactsMgr"});a.sync("EnrichAll",a,{success:function(){},error:p.showError})};m.ReferralWireBase=ReferralWireBase=
l;return m.ReferralWireBase});
