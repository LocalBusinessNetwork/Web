(function(m,f){if("object"===typeof exports){var j=require("jquery"),c=require("underscore"),b=require("backbone");module.exports=f(j,c,b)}else"function"===typeof define&&define.amd&&define(["jquery","underscore","backbone"],f)})(this,function(m,f,j){var c=m||window.jQuery||window.Zepto||window.ender,b={pagingSize:20,errorHandlerTemplate:{location:"/Templates/Patterns/errorHandlerTemplate.html?version=6.0",value:null},SocialNetworkIdentity:{location:"/Templates/SocialProfile/SocialNetworkIdentity.html?version=6.0",
value:null},SocialNetworkLogin:{location:"/Templates/SocialProfile/SocialNetworkLogin.html?version=6.0",value:null},staticHelpTemplate:{location:"/Templates/Patterns/staticHelpTemplate.html?version=6.0",value:null},spinRefCount:0,mtgCheckinWindowMinutes:120,mtgCheckinWindowDistance:400,init:function(a){b.options=a},cachein:function(a,d){localStorage.setItem(a,d)},cacheout:function(a){return localStorage.getItem(a)},JSONServerRequest:function(a,d,e){var c=new XMLHttpRequest;c.open(d,a,!1);c.send();
return 400==c.status?(b.FYI(c.response),null):f.isUndefined(e)?jQuery.parseJSON(c.responseText):c.responseText},getJSON:function(a){return b.JSONServerRequest(a,"GET")},getTemplate:function(a){return b.JSONServerRequest(a,"GET","html")},validEmail:function(a){return/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.(?:us|com|net|org|biz|edu|gov|mobi|aero|museum|name|guru|club|email|house|uno|photography|solutions|today|tips|homes|info)$/.test(a)},GetCaptcha:function(){return JSONServerRequest("/rwWebRequest?Captcha=GET",
"GET").Captcha},Peek:function(a){var d=new XMLHttpRequest;d.open("GET","/rwWebRequest?Peek="+a,!1);d.send();return 400==d.status?null:jQuery.parseJSON(d.responseText)}};b.vmSnippet=j.Model.extend({options:null,initialize:function(a){this.options=a},get:function(a,d){var e=c.Deferred(),b=c.ajax({type:"POST",url:"/rwWebRequest?",async:f.isUndefined(d)||f.isUndefined(d.async)?!0:d.async,cache:!0,dataType:"json",data:a,timeout:75E3});b.done(function(a){e.resolve(a.snippet)});b.fail(function(a,d,b){e.reject(a,
d,b)});return e}});b.StandardModel=j.Model.extend({idAttribute:"id",options:null,initialize:function(a){this.options=a},call:function(a,d,e){return this.sync(a,d,e)},sync:function(a,d,e){var b={};"read"==a?b=this.options:(b=d.toJSON(),b.module=this.options.module,b.bo=this.options.bo,b.bc=this.options.bc);b.act=a;return this.doAjax("POST",b,e)},doAjax:function(a,d,e){var g=this,h=c.Deferred();b.spinOn();a=c.ajax({type:a,url:"/rwWebRequest?",async:f.isUndefined(e)||f.isUndefined(e.async)?!0:e.async,
cache:!0,dataType:"json",data:d,timeout:75E3});a.done(function(a,d,l){var k={};c.hasVal(a)&&c.hasVal(a.data)&&(k=f.isUndefined(e)?JSON.parse(a.data):f.isUndefined(e.raw)?JSON.parse(a.data):a.data,g.clear(),f.isUndefined(k._id)||(k.id=k._id.$oid));b.spinOff();f.isUndefined(e)||(f.isFunction(e.success)&&e.success(k,d,l),f.isFunction(e.done)&&e.done(g,d,l));h.resolve(k)});a.fail(function(a,d,c){b.spinOff();f.isUndefined(e)||(f.isFunction(e.error)&&e.error(a,d,c),f.isFunction(e.done)&&e.done());h.reject(a,
d,c)});return h}});b.StandardModel.extend=j.Model.extend;b.StandardCollection=j.Collection.extend({model:b.StandardModel,initialize:function(a){this.options=a},setRawData:function(a){var b=this;f.isUndefined(a)||f.each(a,function(a){b.create(a)})},call:function(a,b,e){return this.sync(a,b,e)},sync:function(a,b,e){a={};c.hasVal(this.options.act)?a="associate"==this.options.act?b.dataout:{data:JSON.stringify(this.options)}:(this.options.act="read",a={data:JSON.stringify(this.options)});return this.doAjax("POST",
a,e)},doAjax:function(a,d,e){var g=this,h=c.Deferred();b.spinOn();a=c.ajax({type:"POST",url:"/rwWebRequest?",async:f.isUndefined(e)||f.isUndefined(e.async)?!0:e.async,cache:!0,dataType:"json",data:d,timeout:75E3});a.done(function(a,d,l){var k=new j.Collection;c.hasVal(a)&&c.hasVal(a.data)&&(a=JSON.parse(a.data),a=c.toArray(a),f.each(a,function(a){a.id=!f.isNull(a._id)?a._id.$oid:0;var e=new b.StandardModel({module:g.options.module});e.set(a);if(!f.isUndefined(g.options.calculatedFields))for(var d in g.options.calculatedFields){a=
g.options.calculatedFields[d](e);var c={};c[d]=a;e.set(c)}k.add(e,{silent:!0})}));g.reset();b.spinOff();f.isUndefined(e)||(f.isFunction(e.success)&&e.success(k.models,d,l),f.isFunction(e.done)&&e.done(g.models,d,l));h.resolve(k)});a.fail(function(a,d,c){b.spinOff();f.isUndefined(e)||(f.isFunction(e.error)&&e.error(a,d,c),f.isFunction(e.done)&&e.done());h.reject(a,d,c)});return h}});b.StandardCollection.extend=j.Collection.extend;b.LOVCollection=b.StandardCollection.extend({doCache:function(a){if(c.hasVal(a.skipCache)&&
a.skipCache)return!1;var d=b.cacheout("LOV_"+this.options.LovType);if(!c.hasVal(d))return!1;var d=JSON.parse(d),e=this;e.reset();var g=new j.Collection;f.each(d,function(a){if(a){a.id=a._id.$oid;var d=new b.StandardModel({module:e.options.module});d.set(a);g.add(d,{silent:!0})}});f.isFunction(a.success)&&a.success(g.models,null,null);return!0},sync:function(a,d,e){var f=this;this.doCache(e)||(f.options.act="read",a=f.doAjax("POST",f.options,e),c.when(a).done(function(){b.cachein("LOV_"+f.options.LovType,
JSON.stringify(f.models))}))}});b.getLov=function(a,d){var e=new b.LOVCollection({module:"LovMgr",LovType:a,Locale:"ENU"});e.fetch({add:!0,async:!1,error:b.showError});return f.find(e.models,function(a){return a.get("GlobalVal")==d})};b.getLovDisplayVal=function(a,d){var e=b.getLov(a,d);return c.hasVal(e)?e.get("DisplayVal"):""};b.ErrorView=j.View.extend({options:null,initialize:function(a){this.options=a},events:{"click #cancelError":"cancel"},cancel:function(a){c("#ErrorMsgContainer").hide(50);
c("#ErrorMsgContainer").html("");c("#pickBackground").hide(50);a.preventDefault()},render:function(){var a=null;c.hasVal(this.options.status)&&c.hasVal(this.options.status.status)?a=this.options.status.status:c.hasVal(this.options.request)&&c.hasVal(this.options.request.status)&&(a=this.options.request.status);var d=null,d=a?!c.hasVal(this.options.status.responseText)?this.options.request.responseText:this.options.status.responseText:this.options.status.statusText;f.isNull(b.errorHandlerTemplate.value)&&
(b.errorHandlerTemplate.value=b.getTemplate(b.errorHandlerTemplate.location));c(this.el).html(f.template(b.errorHandlerTemplate.value,{msg:d,status:a,_:f}));ga("send","event","Error",a,d);return this}});b.HelpView=j.View.extend({options:null,id:"#ErrorMsgContainer",backgroundSelector:".overlay-background",promise:null,initialize:function(a){this.options=a;this.id=c.hasVal(a.id)?a.id:this.id;this.backgroundSelector=c.hasVal(a.backgroundSelector)?a.backgroundSelector:this.backgroundSelector;this.promise=
c.Deferred()},dismiss:function(a){a.data.promise.resolve(c("#DONTSHOW:checked").length);c("#dismissHelp").off("click");c(this.id).hide();c(this.id).html("");c(this.backgroundSelector).hide();a.preventDefault()},render:function(){f.isNull(b.staticHelpTemplate.value)&&(b.staticHelpTemplate.value=b.JSONServerRequest(b.staticHelpTemplate.location,"GET","html"));c(this.id).html(f.template(b.staticHelpTemplate.value,this.options)).trigger("create");c(this.backgroundSelector).show();c(this.id).show(50);
c("#dismissHelp").on("click",this,this.dismiss);return this.promise}});b.FYI=function(a,b){var e=c.Deferred(),g=c("#FYIContainer");g.html("<table style='bakcground-color:yellow'><tr><td align='right'><img id='closeAction' height='16px' width='16px' src='"+rwFB.CDN+"/images/icons/closeIconBlack.png'/></td></tr><tr><td align='left'><div style='font-size:14pt;color:blue'>"+a+"</div></td></tr></table>");f.isUndefined(b)?g.css({top:"50%",left:"60%","margin-top":"-150px","margin-left":"-200px"}):g.css(b);
g.show();g.on("click",g,function(){c("#FYIContainer").hide();e.resolve()});return e};b.showError=function(a,d,e){ga("send","event","button","click","nav-buttons");d&&401==d.status?(ga("send","event","Error",d.status),window.location="/login.jsp"):a&&401==a.status?(ga("send","event","Error",a.status),window.location="/login.jsp"):(a=new b.ErrorView({request:a,status:d,error:e}),c("#ErrorMsgContainer").html(a.render().el).trigger("create"),c("#pickBackground").show(50),c("#ErrorMsgContainer").show(50))};
b.showWaitDialog=function(a,b,e){var g=c.Deferred(),h=c("#PopupContainer");h.html(f.template(a,{options:b}));h.addClass("confirmation");c(".overlay-background").show();h.show();h.one("click","[popEvent]",b,function(a){c(".overlay-background").hide();h.removeClass("confirmation");h.hide();f.isFunction(e)&&e(a);g.resolve()});return g};b.hideWaitDialog=function(a){var b=c("#PopupContainer");c(".overlay-background").hide();b.removeClass("confirmation");b.hide();a||window.history.back()};b.FBLogout=function(){var a=
c.Deferred();c.when(facebookReady).done(function(){FB.getLoginStatus(function(d){"connected"===d.status?(f.isNull(b.SocialNetworkIdentity.value)&&(b.SocialNetworkIdentity.value=b.getTemplate(b.SocialNetworkIdentity.location)),b.showWaitDialog(b.SocialNetworkIdentity.value,{title:"Facebook Identity",src:"https://graph.facebook.com/"+d.authResponse.userID+"/picture"},function(b){"SocialYes"==b.currentTarget.id?a.resolve(d):(console.log(b),FB.logout(function(b){rwFB.fbUserID=void 0;a.resolve(b)}))})):
a.resolve(d)})}).fail(function(d){b.FYI(d);a.reject(d)});return a};b.FBLogin=function(){var a=c.Deferred();c.when(facebookReady).done(function(){try{FB.getLoginStatus(function(b){"connected"===b.status?(rwFB.fbUserID=b.authResponse.userID,a.resolve(b.status)):"not_authorized"===b.status?a.reject("Facebook Interface has not been authorized. Please clear your browser cache, logout all your facebook sessions from all browsers. Connect again"):FB.login(function(b){b.authResponse?(rwFB.fbUserID=b.authResponse.userID,
a.resolve("Welcome! Facebook Logged you in.")):a.reject("Facebook Interface has not been authorized. Please connect again")})},!0)}catch(b){console.log(b.message),a.reject("An error occured connecting to Facebook Interface. Please clear your browser cache. logout all your facebook sessions from all browsers. connect again. Details: "+b.message)}}).fail(function(){a.reject("Facebook Interface has not been connected. Please clear your browser cache. logout all your facebook sessions from all browsers. Connect again.")});
return a};b.FBGetFriends=function(a){var d=c.Deferred();c.when(facebookReady).done(function(){b.FBLogin().done(function(){var e="/me/friends",c="?offset="+(f.isUndefined(a.offset)?"0":a.offset)+"&limit="+b.pagingSize,e=e+c;b.spinOn();FB.api(e,function(a){b.spinOff();!a||a.error?(b.FYI("An error occurred looking up facebook friends"),d.reject(a)):d.resolve(a.data)},{scope:"publish_actions, status_update, manage_pages"})}).fail(function(a){d.reject(a)})}).fail(function(a){d.reject(a)});return d};b.LNLogin=
function(){var a=c.Deferred();c.when(linkedInReady).done(function(){IN.User.authorize(function(){IN.API.Profile("me").fields(["id","pictureUrl","summary","headline"]).result(function(b){rwFB.lnUserID=b.values[0].id;a.resolve(b.values[0])}).error(function(b){a.reject(b)})})});return a};b.LNAuthenticate=function(){var a=c.Deferred();c.when(linkedInReady).done(function(){try{IN.API.Profile("me").fields(["id","pictureUrl","summary","headline"]).result(function(b){a.resolve(b.values[0])}).error(function(b){"401"==
b.status&&IN.User.refresh();a.reject(b)})}catch(d){c.when(b.LNLogin()).done(function(b){a.resolve(b)})}});return a};b.LNGetConnections=function(a){var d=c.Deferred();c.when(linkedInReady).done(function(){c.when(b.LNAuthenticate()).done(function(c){rwFB.lnUserID=c.id;b.spinOn();var g={};g.start=f.isUndefined(a.offset)?"0":a.offset;g.count=b.pagingSize;IN.API.Connections("me").fields(["id","firstName","lastName","pictureUrl"]).params(g).result(function(a){b.spinOff();f.isUndefined(a.values)?d.reject("NO RECORDS"):
d.resolve(c,a.values)}).error(function(a){b.spinOff();"401"==a.status&&IN.User.refresh();b.FYI("Status : "+a.status+" Error: "+a.message);d.reject(a)})}).fail(function(a){"401"==a.status&&IN.User.refresh();d.reject(a)})}).fail(function(a){d.reject(a)});return d};b.FBMatch=function(a){var d=c.Deferred();c.when(facebookReady).done(function(){f.isNull(b.SocialNetworkLogin.value)&&(b.SocialNetworkLogin.value=b.getTemplate(b.SocialNetworkLogin.location));b.FBGetFriends(a).done(function(a){a||d.fail();
var g=new b.StandardCollection;g.setRawData(a);a={act:"getFBFriends",FaceBookId:rwFB.fbUserID,data:JSON.stringify(a)};c.ajax({type:"POST",url:"/fbhook?",async:!0,cache:!1,dataType:"json",data:a,timeout:25E3}).done(function(a){for(var b=0;b<a.length;b++){var c=a[b],e=c.substr(1,c.length),c=c.substr(0,1),e=g.where({id:e});!f.isUndefined(e)&&0<e.length&&("m"==c?e[0].set({rwmember:!0}):e[0].set({rwinvited:!0}))}d.resolve(g)}).fail(function(a){d.reject(a.status)})}).fail(function(a){d.reject(a)})}).fail(function(a){d.reject(a)});
return d};b.LNMatch=function(a){var d=c.Deferred();c.when(linkedInReady).done(function(){f.isNull(b.SocialNetworkLogin.value)&&(b.SocialNetworkLogin.value=b.getTemplate(b.SocialNetworkLogin.location));b.LNGetConnections(a).done(function(a,g){var h=new b.StandardCollection;h.setRawData(g);var j={act:"getINConnections",LNProfileId:rwFB.lnUserID,data:JSON.stringify(g)};c.ajax({type:"POST",url:"/fbhook?",async:!0,cache:!1,dataType:"json",data:j,timeout:25E3}).done(function(a){for(var b=0;b<a.length;b++){var c=
h.where({id:a[b]});!f.isUndefined(c)&&0<c.length&&c[0].set({rwmember:!0})}d.resolve(h)}).fail(function(a){d.reject(a)})}).fail(function(a){d.reject(a)})}).fail(function(a){d.reject(a)});return d};b.spinOn=function(a){f.isUndefined(a)?(b.spinRefCount||c.mobile.loading("show",{text:"loading",textVisible:!0,theme:"a",html:""}),b.spinRefCount++):(c("#rwSpinner").css("top",a.top),c("#rwSpinner").css("left",a.left),c("#rwSpinner").css("z-index",2E4),c("#rwSpinner").show())};b.spinOff=function(a){f.isUndefined(a)?
(b.spinRefCount--,0==b.spinRefCount&&c.mobile.loading("hide")):c("#rwSpinner").hide()};j.rwcore=rwcore=b;return j.rwcore});
