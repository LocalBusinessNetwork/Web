(function(a,g){if("object"===typeof exports){var h=require("jquery"),j=require("underscore"),b=require("backbone");require("rwcore");module.exports=g(h,j,b,rwcore)}else"function"===typeof define&&define.amd&&define(["jquery","underscore","backbone","rwcore"],g)})(this,function(a,g,h,j){var b=j||window.jQuery||window.Zepto||window.ender,f={resetPasswordTemplate:{location:"/Templates/custom/resetPasswordTemplate.html",value:null}};f.Router=h.Router.extend({params:"",routes:{passwordReset:"passwordReset",
"*actions":"defaultRoute"},defaultRoute:function(){if(g.isNull(rwFB.loginEmail)||g.isEmpty(rwFB.loginEmail))rwFB.loginEmail=localStorage.getItem("rwLoginId");rwFB.loginEmail&&(a("#loginForm #login").val(rwFB.loginEmail),rwFB.loginChecked=!0)},register:function(){if(!a.hasVal(a("#registerForm #login").val())||!a.hasVal(a("#registerForm #password").val())||!a.hasVal(a("#registerForm #firstName").val())||!a.hasVal(a("#registerForm #lastName").val()))b.FYI("Please fill in all the required information");
else if(b.validEmail(a("#registerForm #login").val()))if(6>a("#registerForm #password").val().length)b.FYI("<h4> Weak Password </h4> Password should be 6 letters or more. Please use Alpha Numerics. <p> Example: Abc1Xyz2");else{var d={module:"SecMgr",act:"create",login:a("#registerForm #login").val(),password:a("#registerForm #password").val(),firstName:a("#registerForm #firstName").val(),lastName:a("#registerForm #lastName").val(),postalCodeAddress_work:a("#registerForm #postalCode").val(),invitationId:a("#registerForm #invitationId").val(),
tenant:rwApp.tenant},d=a.ajax({type:"POST",url:"/rwWebRequest?",async:!1,cache:!0,dataType:"json",data:{data:JSON.stringify(d)}});d.done(function(){window.localStorage.setItem("rwLoginId",a("#registerForm #login").val());-1<rwFB.OSType.indexOf("IPHONE")?window.location="/"+rwFB.tenant+"/Templates/Other/iphoneWelcome.html":-1<rwFB.OSType.indexOf("ANDROID")?window.location="/"+rwFB.tenant+"/Templates/Other/androidWelcome.html":(b.FYI("Congratulations, Your STN Connect account has been created and a confirmation email has been sent to your login email address with your STN Connect login and password. Please save it safely for your records."),
ga("send","event","System","Registered",a("#registerForm #login").val()),window.location="/rw.jsp#home")});d.fail(b.showError)}else b.FYI("<h4>Login Email should be a valid email address</h4> Example: bob@acme.com. <p>You Login email address will be used to communicate with you.")},login:function(){var d=this,c=a("#login").val();6>c.length||!b.validEmail(c)?b.FYI("<h4>Login Email should be a valid email address</h4> Example: bob@acme.com."):6>a("#password").val().length?b.FYI("<h4>Password is short</h4> Your password should be atleast 6 letters long"):
(c=a("#loginForm").serialize(),c=a.ajax({type:"POST",url:"/rwWebRequest?module=SecMgr&",async:!1,cache:!0,dataType:"json",data:c}),c.done(function(){window.localStorage.setItem("rwLoginId",a("#loginForm #login").val());ga("send","event","System","LoggedIn",a("#loginForm #login").val());window.location=d.baseUrl}),c.fail(function(a,d,c){b.showError(a,d,c)}))},checkLoginExists:function(d){var c=a.Deferred(),e=d.val();if(6>e.length||!b.validEmail(e))b.FYI("<h4>Login Email should be a valid email address</h4> Example: bob@acme.com. <p>You Login email address will be used to communicate with you."),
c.reject();else return e=new b.StandardModel({module:"SecMgr"}),e.set({login:d.val()}),d=e.call("confirmLoginId",e),a.when(d).done(function(){b.FYI("<h4>This Login Email has already been registered.</h4> We sent you an email at the time of registration with your login information. Please check your email folders including junk folders to locate it. Or goto login screen, request a password reset.");c.reject()}).fail(function(){c.resolve()}),c},help:function(a){b.FYI("help"+a)},passwordReset:function(){(new f.passwordResetWizard({})).render()},
initialize:function(a){this.params=a.params;this.homepage=a.homepage;this.tenant=a.tenant;this.OStype=a.OStype;this.baseUrl=a.baseUrl;b.init(a)}});f.passwordResetWizard=h.View.extend({options:null,initialize:function(a){this.options=a},events:{"click #confirmLogin":"confirmLogin","click #resetPassword":"resetPassword"},confirmLogin:function(d){var c=a("#resetpw_login").val();if(6>c.length||!b.validEmail(c))b.FYI("<h4>Login Email should be a valid email address</h4> Example: bob@acme.com.");else{var e=
new b.StandardModel({module:"SecMgr"});e.set({login:c});c=e.call("confirmLoginId",e);a.when(c).done(function(){a("#Step1").hide(0);a("#Step2").show(0)}).fail(function(a,c,d){b.showError(a,c,d)});d.preventDefault()}},resetPassword:function(d){var c=new b.StandardModel({module:"SecMgr"});c.set({login:a("#resetpw_login").val()});c.call("resetPassword",c,{add:!0,error:b.showError,success:function(){a("#PopupContainer").hide(0);a("#PopupContainer").html("");a("#pickBackground").hide(0);ga("send","event",
"System","ResetPassword",a("#resetpw_login").val());window.location="/login.jsp"}});d.preventDefault()},cancel:function(){a("#PopupContainer").hide(0);a("#PopupContainer").html("");a("#pickBackground").hide(0);window.location="/login.jsp"},render:function(){new b.StandardModel({module:"SecMgr"});g.isNull(f.resetPasswordTemplate.value)&&(f.resetPasswordTemplate.value=b.getTemplate(f.resetPasswordTemplate.location));var d=g.template(f.resetPasswordTemplate.value,{});a("#PopupContainer").html(d).trigger("create");
a("#PopupContainer").on("click","#confirmLogin",this,this.confirmLogin);a("#PopupContainer").on("click","#resetPassword",this,this.resetPassword);a("#PopupContainer").on("click","#CancelResetTxn",this,this.cancel);a("#pickBackground").show(0);a("#PopupContainer").show(0);return this}});h.RWAuth=RWAuth=f;return h.RWAuth});
