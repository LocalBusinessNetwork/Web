(function(m,f){if("object"===typeof exports){var h=require("jquery"),c=require("underscore"),d=require("backbone");module.exports=f(h,c,d)}else"function"===typeof define&&define.amd&&define(["jquery","underscore","backbone"],f)})(this,function(m,f,h){var c=m||window.jQuery||window.Zepto||window.ender,d={pagingSize:20,errorHandlerTemplate:{location:"/Templates/Patterns/errorHandlerTemplate.html?version=6.0",value:null},SocialNetworkIdentity:{location:"/Templates/SocialProfile/SocialNetworkIdentity.html?version=6.0",
value:null},SocialNetworkLogin:{location:"/Templates/SocialProfile/SocialNetworkLogin.html?version=6.0",value:null},staticHelpTemplate:{location:"/Templates/Patterns/staticHelpTemplate.html?version=6.0",value:null},init:function(a){d.options=a},cachein:function(a,b){localStorage.setItem(a,b)},cacheout:function(a){return localStorage.getItem(a)},JSONServerRequest:function(a,b,e){var c=new XMLHttpRequest;c.open(b,a,!1);c.send();return 400==c.status?(d.FYI(c.response),null):f.isUndefined(e)?jQuery.parseJSON(c.responseText):
c.responseText},getJSON:function(a){return d.JSONServerRequest(a,"GET")},getTemplate:function(a){return d.JSONServerRequest(a,"GET","html")},validEmail:function(a){return/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.(?:com|net|org|biz|edu|gov|mobi|aero|museum|name)$/.test(a)},GetCaptcha:function(){return JSONServerRequest("/rwWebRequest?Captcha=GET","GET").Captcha},Peek:function(a){var b=new XMLHttpRequest;b.open("GET","/rwWebRequest?Peek="+a,!1);b.send();return 400==b.status?null:jQuery.parseJSON(b.responseText)}};
d.vmSnippet=h.Model.extend({options:null,initialize:function(a){this.options=a},get:function(a,b){var e=c.Deferred(),d=c.ajax({type:"POST",url:"/rwWebRequest?",async:f.isUndefined(b)||f.isUndefined(b.async)?!0:b.async,cache:!0,dataType:"json",data:a,timeout:75E3});d.done(function(a){e.resolve(a.snippet)});d.fail(function(a,b,c){e.reject(a,b,c)});return e}});d.StandardModel=h.Model.extend({idAttribute:"id",options:null,initialize:function(a){this.options=a},call:function(a,b,e){return this.sync(a,
b,e)},sync:function(a,b,e){var c={};"read"==a?c=this.options:(c=b.toJSON(),c.module=this.options.module,c.bo=this.options.bo,c.bc=this.options.bc);c.act=a;return this.doAjax("POST",c,e)},doAjax:function(a,b,e){var d=this,k=c.Deferred();a=c.ajax({type:a,url:"/rwWebRequest?",async:f.isUndefined(e)||f.isUndefined(e.async)?!0:e.async,cache:!0,dataType:"json",data:b,timeout:75E3});a.done(function(a,b,l){var j={};c.hasVal(a)&&c.hasVal(a.data)&&(j=f.isUndefined(e)?JSON.parse(a.data):f.isUndefined(e.raw)?
JSON.parse(a.data):a.data,d.clear(),f.isUndefined(j._id)||(j.id=j._id.$oid));f.isUndefined(e)||(f.isFunction(e.success)&&e.success(j,b,l),f.isFunction(e.done)&&e.done(d,b,l));k.resolve(j)});a.fail(function(a,b,c){f.isUndefined(e)||(f.isFunction(e.error)&&e.error(a,b,c),f.isFunction(e.done)&&e.done());k.reject(a,b,c)});return k}});d.StandardModel.extend=h.Model.extend;d.StandardCollection=h.Collection.extend({model:d.StandardModel,initialize:function(a){this.options=a},setRawData:function(a){var b=
this;f.isUndefined(a)||f.each(a,function(a){b.create(a)})},call:function(a,b,e){return this.sync(a,b,e)},sync:function(a,b,e){a={};c.hasVal(this.options.act)?a="associate"==this.options.act?b.dataout:{data:JSON.stringify(this.options)}:(this.options.act="read",a={data:JSON.stringify(this.options)});return this.doAjax("POST",a,e)},doAjax:function(a,b,e){var g=this,k=c.Deferred();a=c.ajax({type:"POST",url:"/rwWebRequest?",async:f.isUndefined(e)||f.isUndefined(e.async)?!0:e.async,cache:!0,dataType:"json",
data:b,timeout:75E3});a.done(function(a,b,l){var j=new h.Collection;c.hasVal(a)&&c.hasVal(a.data)&&(a=JSON.parse(a.data),a=c.toArray(a),f.each(a,function(a){a.id=!f.isNull(a._id)?a._id.$oid:0;var b=new d.StandardModel({module:g.options.module});b.set(a);if(!f.isUndefined(g.options.calculatedFields))for(var e in g.options.calculatedFields){a=g.options.calculatedFields[e](b);var c={};c[e]=a;b.set(c)}j.add(b,{silent:!0})}));g.reset();f.isUndefined(e)||(f.isFunction(e.success)&&e.success(j.models,b,l),
f.isFunction(e.done)&&e.done(g.models,b,l));k.resolve(j)});a.fail(function(a,b,c){f.isUndefined(e)||(f.isFunction(e.error)&&e.error(a,b,c),f.isFunction(e.done)&&e.done());k.reject(a,b,c)});return k}});d.StandardCollection.extend=h.Collection.extend;d.LOVCollection=d.StandardCollection.extend({doCache:function(a){if(c.hasVal(a.skipCache)&&a.skipCache)return!1;var b=d.cacheout("LOV_"+this.options.LovType);if(!c.hasVal(b))return!1;var b=JSON.parse(b),e=this;e.reset();var g=new h.Collection;f.each(b,
function(a){if(a){a.id=a._id.$oid;var b=new d.StandardModel({module:e.options.module});b.set(a);g.add(b,{silent:!0})}});f.isFunction(a.success)&&a.success(g.models,null,null);return!0},sync:function(a,b,e){var f=this;this.doCache(e)||(f.options.act="read",a=f.doAjax("POST",f.options,e),c.when(a).done(function(){d.cachein("LOV_"+f.options.LovType,JSON.stringify(f.models))}))}});d.getLovDisplayVal=function(a,b){var e=new d.LOVCollection({module:"LovMgr",LovType:a,Locale:"ENU"});e.fetch({add:!0,async:!1,
error:d.showError});e=f.find(e.models,function(a){return a.get("GlobalVal")==b});return c.hasVal(e)?e.get("DisplayVal"):""};d.ErrorView=h.View.extend({options:null,initialize:function(a){this.options=a},events:{"click #cancelError":"cancel"},cancel:function(a){c("#ErrorMsgContainer").hide(50);c("#ErrorMsgContainer").html("");c("#pickBackground").hide(50);a.preventDefault()},render:function(){var a=null;c.hasVal(this.options.status)&&c.hasVal(this.options.status.status)?a=this.options.status.status:
c.hasVal(this.options.request)&&c.hasVal(this.options.request.status)&&(a=this.options.request.status);var b=null,b=a?!c.hasVal(this.options.status.responseText)?this.options.request.responseText:this.options.status.responseText:this.options.status.statusText;f.isNull(d.errorHandlerTemplate.value)&&(d.errorHandlerTemplate.value=d.getTemplate(d.errorHandlerTemplate.location));c(this.el).html(f.template(d.errorHandlerTemplate.value,{msg:b,status:a,_:f}));return this}});d.HelpView=h.View.extend({options:null,
id:"#ErrorMsgContainer",backgroundSelector:".overlay-background",promise:null,initialize:function(a){this.options=a;this.id=c.hasVal(a.id)?a.id:this.id;this.backgroundSelector=c.hasVal(a.backgroundSelector)?a.backgroundSelector:this.backgroundSelector;this.promise=c.Deferred()},dismiss:function(a){a.data.promise.resolve(c("#DONTSHOW:checked").length);c("#dismissHelp").off("click");c(this.id).hide();c(this.id).html("");c(this.backgroundSelector).hide();a.preventDefault()},render:function(){f.isNull(d.staticHelpTemplate.value)&&
(d.staticHelpTemplate.value=d.JSONServerRequest(d.staticHelpTemplate.location,"GET","html"));c(this.id).html(f.template(d.staticHelpTemplate.value,this.options)).trigger("create");c(this.backgroundSelector).show();c(this.id).show(50);c("#dismissHelp").on("click",this,this.dismiss);return this.promise}});d.FYI=function(a){var b=c("#FYIContainer");b.html("<table style='bakcground-color:yellow'><tr><td align='right'><img id='closeAction' height='16px' width='16px' src='"+rwFB.CDN+"/images/icons/closeIconBlack.png'/></td></tr><tr><td align='left'><div style='font-size:14pt;color:blue'>"+
a+"</div></td></tr></table>");b.show();b.on("click",b,function(){c("#FYIContainer").hide()})};d.showError=function(a,b,e){b&&401==b.status?window.location="/login.jsp":a&&401==a.status?window.location="/login.jsp":(a=new d.ErrorView({request:a,status:b,error:e}),c("#ErrorMsgContainer").html(a.render().el).trigger("create"),c("#pickBackground").show(50),c("#ErrorMsgContainer").show(50))};d.showWaitDialog=function(a,b,e){var d=c("#PopupContainer");d.html(f.template(a,{options:b}));d.addClass("confirmation");
c(".overlay-background").show();d.show();d.one("click","[popEvent]",b,function(a){c(".overlay-background").hide();d.hide();f.isFunction(e)&&e(a)})};d.hideWaitDialog=function(a){var b=c("#PopupContainer");c(".overlay-background").hide();b.hide();a||window.history.back()};d.FBLogout=function(){var a=c.Deferred();c.when(facebookReady).done(function(){FB.getLoginStatus(function(b){"connected"===b.status?(f.isNull(d.SocialNetworkIdentity.value)&&(d.SocialNetworkIdentity.value=d.getTemplate(d.SocialNetworkIdentity.location)),
d.showWaitDialog(d.SocialNetworkIdentity.value,{title:"Facebook Identity",src:"https://graph.facebook.com/"+b.authResponse.userID+"/picture"},function(e){"SocialYes"==e.currentTarget.id?a.resolve(b):(console.log(e),FB.logout(function(b){rwFB.fbUserID=void 0;a.resolve(b)}))})):a.resolve(b)})}).fail(function(b){d.FYI(b);a.reject(b)});return a};d.FBLogin=function(){var a=c.Deferred();c.when(facebookReady).done(function(){try{FB.getLoginStatus(function(b){"connected"===b.status?(rwFB.fbUserID=b.authResponse.userID,
a.resolve(b.status)):"not_authorized"===b.status?a.reject("Facebook Interface has not been authorized. Please clear your browser cache, logout all your facebook sessions from all browsers. Connect again"):FB.login(function(b){b.authResponse?(rwFB.fbUserID=b.authResponse.userID,a.resolve("Welcome! Facebook Logged you in.")):a.reject("Facebook Interface has not been authorized. Please connect again")})},!0)}catch(b){console.log(b.message),a.reject("An error occured connecting to Facebook Interface. Please clear your browser cache. logout all your facebook sessions from all browsers. connect again. Details: "+
b.message)}}).fail(function(){a.reject("Facebook Interface has not been connected. Please clear your browser cache. logout all your facebook sessions from all browsers. Connect again.")});return a};d.FBGetFriends=function(a){var b=c.Deferred();c.when(facebookReady).done(function(){d.FBLogin().done(function(){var c="/me/friends",g="?offset="+(f.isUndefined(a.offset)?"0":a.offset)+"&limit="+d.pagingSize;FB.api(c+g,function(a){!a||a.error?(d.FYI("An error occurred looking up facebook friends"),b.reject(a)):
b.resolve(a.data)},{scope:"publish_actions, status_update, manage_pages"})}).fail(function(a){b.reject(a)})}).fail(function(a){b.reject(a)});return b};d.LNLogin=function(){var a=c.Deferred();c.when(linkedInReady).done(function(){IN.User.authorize(function(){IN.API.Profile("me").fields(["id","pictureUrl","summary","headline"]).result(function(b){rwFB.lnUserID=b.values[0].id;a.resolve(b.values[0])}).error(function(b){a.reject(b)})})});return a};d.LNAuthenticate=function(){var a=c.Deferred();c.when(linkedInReady).done(function(){try{IN.API.Profile("me").fields(["id",
"pictureUrl","summary","headline"]).result(function(b){a.resolve(b.values[0])}).error(function(b){"401"==b.status&&IN.User.refresh();a.reject(b)})}catch(b){c.when(d.LNLogin()).done(function(b){a.resolve(b)})}});return a};d.LNGetConnections=function(a){var b=c.Deferred();c.when(linkedInReady).done(function(){c.when(d.LNAuthenticate()).done(function(c){rwFB.lnUserID=c.id;var g={};g.start=f.isUndefined(a.offset)?"0":a.offset;g.count=d.pagingSize;IN.API.Connections("me").fields(["id","firstName","lastName",
"pictureUrl"]).params(g).result(function(a){f.isUndefined(a.values)?b.reject("NO RECORDS"):b.resolve(c,a.values)}).error(function(a){"401"==a.status&&IN.User.refresh();d.FYI("Status : "+a.status+" Error: "+a.message);b.reject(a)})}).fail(function(a){"401"==a.status&&IN.User.refresh();b.reject(a)})}).fail(function(a){b.reject(a)});return b};d.FBMatch=function(a){var b=c.Deferred();c.when(facebookReady).done(function(){f.isNull(d.SocialNetworkLogin.value)&&(d.SocialNetworkLogin.value=d.getTemplate(d.SocialNetworkLogin.location));
d.FBGetFriends(a).done(function(a){a||b.fail();var g=new d.StandardCollection;g.setRawData(a);a={act:"getFBFriends",FaceBookId:rwFB.fbUserID,data:JSON.stringify(a)};c.ajax({type:"POST",url:"/fbhook?",async:!0,cache:!1,dataType:"json",data:a,timeout:25E3}).done(function(a){for(var c=0;c<a.length;c++){var d=a[c],e=d.substr(1,d.length),d=d.substr(0,1),e=g.where({id:e});!f.isUndefined(e)&&0<e.length&&("m"==d?e[0].set({rwmember:!0}):e[0].set({rwinvited:!0}))}b.resolve(g)}).fail(function(a){b.reject(a.status)})}).fail(function(a){b.reject(a)})}).fail(function(a){b.reject(a)});
return b};d.LNMatch=function(a){var b=c.Deferred();c.when(linkedInReady).done(function(){f.isNull(d.SocialNetworkLogin.value)&&(d.SocialNetworkLogin.value=d.getTemplate(d.SocialNetworkLogin.location));d.LNGetConnections(a).done(function(a,g){var h=new d.StandardCollection;h.setRawData(g);var m={act:"getINConnections",LNProfileId:rwFB.lnUserID,data:JSON.stringify(g)};c.ajax({type:"POST",url:"/fbhook?",async:!0,cache:!1,dataType:"json",data:m,timeout:25E3}).done(function(a){for(var c=0;c<a.length;c++){var d=
h.where({id:a[c]});!f.isUndefined(d)&&0<d.length&&d[0].set({rwmember:!0})}b.resolve(h)}).fail(function(a){b.reject(a)})}).fail(function(a){b.reject(a)})}).fail(function(a){b.reject(a)});return b};d.spinOn=function(a){f.isUndefined(a)?c.mobile.loading("show",{text:rwFB.rwTenantName,textVisible:!0,theme:"b",html:""}):(c("#rwSpinner").css("top",a.top),c("#rwSpinner").css("left",a.left),c("#rwSpinner").css("z-index",1E4),c("#rwSpinner").show())};d.spinOff=function(a){f.isUndefined(a)?c.mobile.loading("hide"):
c("#rwSpinner").hide()};h.rwcore=rwcore=d;return h.rwcore});
